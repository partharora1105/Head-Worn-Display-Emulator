<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<!--      <meta http-equiv="refresh" content="0.1" />-->

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='design.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo+Narrow&family=Arimo&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<meta name="description" content="A Student-Led organization for Georgia Tech Community interested in Virtual/Augmented/Mixed Reality"/>
    <title>Experiment</title>
    
  </head>
  <body onmousedown="mouseButton(event)" id="main"  oncontextmenu="return false;">
      <div class="container-fluid bg">
      <div class="row canvas-holder">
        <div class="col-md-11 position-relative">
          
          <div class="demoImg row position-absolute" id="demoImg">
            {%for i in range(0, len)%}
                <p id="page{{i}}">{{txt[i]}}</p>
            {%endfor%}
          </div>
          <div class="position-absolute foundCount" id="counter">
            Found = 0
          </div>
          <div class="counter position-absolute">
            <div class="row" id="page">Page = 1</div>
            <div class="row" id="page"><button onclick="changePage(0)">Chapter 1</button></div>
            <div class="row" id="page"><button onclick="changePage(116)">Chapter 2</button></div>
            <div class="row" id="page"><button onclick="changePage(239)">Chapter 3</button></div>
            <div class="row" id="page"><button onclick="changePage(334)">Chapter 4</button></div>
            <div class="row" id="page"><button onclick="changePage(462)">Chapter 5</button></div>
          </div>
        </div>
        
      </div>
    </div>
      

    <!-- Optional JavaScript; choose one of the two! -->
      <script>
        
        let threshold = 800;
        let h  = 905.512 //2173.2283465; //57.5cm 22.6378inch
        let w = 503.936 //1209.4488189; //32cm 12.5984inch
        //TV => 1 inch = 40px
        let iphone6H = 521.95275591
        let fSize = 20
        // var isHidden = false;
        currPage = 0;
        times = [];
        let startTime = Date.now();
        let laserStartTime = Date.now();
        let totalStartTime = Date.now();
        let laserTime = 0;
        document.onkeydown = KeyCheck;
        leftClick = 0
        // const intervalID = setInterval(checkArduino, 500, "Parameter 1", "Parameter 2");
        setDimesnions();
        setPages()



        setInterval(function() {
            $.ajax({
                url: "/data",
                success: function(data) {
                    console.log(data);
                    if (parseInt(data) > threshold ) {
                      console.log("hide");
                      document.getElementById("demoImg").style.visibility = "hidden";
                        // isHidden == true;
                    } else {
                        console.log("show");
                        document.getElementById("demoImg").style.visibility = "visible";
                        // isHidden = false;
                    }
                }
            });
        }, 200);
        

        function setDimesnions(){
          document.getElementById("demoImg").style.height = (h).toString() + "px" ;
          document.getElementById("demoImg").style.width = (w).toString() + "px" ;
          document.getElementById("demoImg").style.fontSize = ((h/iphone6H) * fSize).toString() + "px" ;
          document.getElementById("demoImg").style.marginLeft = ((screen.width-w)/2).toString() + "px" ;
          document.getElementById("demoImg").style.marginTop =  ((screen.height-h)/4).toString() + "px" ;
        }

        function setPages() {
          for(i = 0; i < {{len}}; i++){
            document.getElementById("page" + i).style.display = "None";
          }
          document.getElementById("page" + 0).style.display = "Block";
        }
          

        function KeyCheck()
          {
              var KeyID = event.keyCode;
              switch(KeyID)
              {
                case 32: //SpaceBar
                document.getElementById("demoImg").style.visibility = "hidden";
                isHidden = !isHidden;
                if (isHidden){
                  laserStartTime = Date.now();
                } else {
                  laserTime += Date.now() - laserStartTime;
                  // console.log("Total Laser Time = " + laserTime)
                }
                break;
                case 37: //Left
                foundWord();
                break;

                case 38: //Up
                back();
                break;

                case 40: //Down
                next();
                break;

                case 68: //Down
                getData();
                break;
              }
          }

        function mouseButton(event) {
          var KeyID = event.button;
          switch(KeyID)
          {
            case 1: //Centre
            foundWord();
            break;

            case 0: //Left
            back();
            break;

            case 2: //Right
            next();
            break;
          }
        }

        function getData() {
          let data = ""
          totalTime = Date.now() - totalStartTime
          totalSentences = totalSent(currPage, times)
          data += "==========DATA=========\n"
          data += "Experiment Time : " + totalTime/1000 + " seconds\n"
          data += "Experiment Pages : " + currPage + "\n"
          data += "-----------------------\n"
          data += "Head Position Accuracy : " + ((totalTime - laserTime)/totalTime)*100 + "%\n"
          data += "Total Time : " + totalTime/1000 + " seconds\n"
          data += "Total Time laser was out : " + laserTime/1000 + " seconds\n"
          data += "-----------------------\n"
          data += "Sentences Accuracy : " + (leftClick/totalSentences)*100 + "%\n"
          data += "Sentences Found : " + leftClick + "\n"
          data += "Total Sentences : " + totalSentences + "\n"
          data += "-----------------------\n"
          data += "Average Time Per Page : " + calculateAverage(times)/1000 + " seconds\n"
          data += "Times Per Page Array (Indices match page num in milliseconds) : " + times + "\n"
          data += "========================="
          console.log(data);
        }

        
        

        
        function changePage(num) {
          saveTime();
          document.getElementById("page" + (currPage)).style.display = "None";
          currPage = num;
          startTime = Date.now();
          document.getElementById("page" + currPage).style.display = "Block";
          document.getElementById("page").innerHTML = "Page = " + (currPage + 1);
        }
        
   

        function foundWord() {
          leftClick++;
          // console.log("Left Click : " + leftClick);
          document.getElementById("counter").innerHTML = "Found = " + leftClick;
        }
        


        function next() {
          if (currPage < {{len}}){
            saveTime();
            currPage++;
            startTime = Date.now();
            document.getElementById("page" + (currPage-1)).style.display = "None";
            document.getElementById("page" + currPage).style.display = "Block";
            document.getElementById("page").innerHTML = "Page = " + (currPage+1);
          }
        }

        function back() {
          if (currPage > 0){
            saveTime();
            currPage--;
            startTime = Date.now();
            document.getElementById("page" + (currPage+1)).style.display = "None";
            document.getElementById("page" + currPage).style.display = "Block";
            document.getElementById("page").innerHTML = "Page = " + (currPage+1);
          }
        }

        function saveTime() {
          let elapsedTime = Date.now() - startTime;
          if (typeof times[currPage] === 'undefined'){
            times[currPage] = elapsedTime
          } else {
            // console.log(times[currPage])
            times[currPage] += elapsedTime
          }
        }

        function calculateAverage(numbers) {
          if (numbers.length === 0) {
            return 0;
          }
          
          let sum = 0;
          let len = 0;
          for (let i = 0; i < numbers.length; i++) {
            if (typeof numbers[i] !== 'undefined' && numbers[i] > 1000) {
              sum += numbers[i];
              len++;
            }
          }
          return sum / len;
        }

        function totalSent(page, times) {
          let arr = {{senCount}}
          // console.log(arr)
          sum = 0
          for(i = 0; i < page + 1; i++) {
            if (typeof times[i] !== 'undefined') {
              sum += arr[i]
            }
          }
          return sum
        }

      </script>

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->
  </body>
</html>